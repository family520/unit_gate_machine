<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>人脸验证</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
		<script src="../js/vue.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/require.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/setRem.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common/constant.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common/utils.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common/native_interface.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="../css/base.css"/>
		<link rel="stylesheet" type="text/css" href="../css/face_verification.css"/>
	</head>
	<body>
		<div class="faceBox" id="faceBox">
			<!-- headerBox -->
			<div class="headerBox">
				<img @click="goHome" src="../img/personal_center/returnBlackIcon.png" alt="">
				<p>人脸验证</p>
			</div>
			<!-- 人脸信息 -->
			<div class="faceInfo">
				<div class="imgBox">
					<img :src="imgUrl" alt="">
				</div>
				<div class="rightFace">
					<p class="oneP" style="margin-top: 0.25rem;">
						<span>{{acsUserName}}</span>
						<span>审核通过</span>
					</p>
					<p class="twoP">
						<span>{{acsUserType}}</span>
						<span>{{acsCreateTime}}</span>
					</p>
				</div>
			</div>
			<!-- 提示 -->
			<p class="tips">{{errorMsg}}</p>
			<!-- 重新上传或者拍照 -->
			<div class="uploadBox">
				<img src="../img/face_verification/uploadIcon.png" alt="">
				<span>重新上传信息</span>
				<input type="file" id="car_file" accept="image/*"   />
			</div>
		</div>
		<script type="text/javascript">
			var face = new Vue({
				el:"#faceBox",
				data: {
					errorMsg: '提示：由于识别效率低于平均识别率，请重新上传信息',
					imgUrl: '../img/face_verification/faceIcon.png',
					acsUserName: 'test',
					acsUserType: '户主',
					acsCreateTime: '2020-01-01 00:00:00',
					acsUID: '',
				},
				methods: {
					goHome() {
						window.location.href = 'home.html';
					},
					initeImgInfo(){
						let that = this;
						console.log(JSON.parse(sessionStorage.getItem('acsUserInfo')) );
						let acsUserInfo = JSON.parse(sessionStorage.getItem('acsUserInfo'));
						if(sessionStorage.acsUserInfo ){
							that.acsUserType = acsUserInfo.userType
							that.acsUserName = acsUserInfo.userName
							that.acsCreateTime = acsUserInfo.createTime
							that.imgUrl = 'data:image/jpeg;base64,'+acsUserInfo.userFaceInfo
							that.acsUID = acsUserInfo.userId
						}else{
							alert("无门禁用户信息，请重新登录");
						}
					},
					doChangeImg(file){
						let that = this;
						var formData = new FormData();
						formData.append('file', file);
						formData.append('userId', that.acsUID);
						console.log(formData);
						let htoken = getStorage("token");
						$.ajax({
							url: getServerUrl()+'app/userinfo/upAcsUserFace',
							type: 'POST',
							headers: {
								token: htoken
							},
							data: formData,
							contentType: false, //jax 中 contentType 设置为 false 是为了避免 JQuery 对其操作，从而失去分界符，而使服务器不能正常解析文件
							processData: false,
							success:function(res){
								if (res.resultCode === '1'){
									alert('提交成功' )
								}else {
									alert( res.resultDesc );
								}
							},
						});
					}
				},
				created(){
					// 初始化用户信息
					this.initeImgInfo()
				}
			});
		</script>
		<script type="text/javascript">
			$(function(){
				//当文本框改变时
				$("#car_file").change(function(){
				   readURL(this);
				});    
				function readURL(input) {
				    if(input.files.length>0){
						var fr = new FileReader();
						console.log(input.files[0].name);
						//判断图片大小
						var filesize = input.files[0];
						if(filesize.size>0){
							if(filesize.size>1024*1024*5){
								alert('请上传小于5MB的图片');
								return false;
							}
						}
						fr.onload = function(e) {
							face.imgUrl = e.target.result;
						}
						fr.readAsDataURL(input.files[0]);//将图片读取为DataURL
						// 更新用户头像接口
						face.doChangeImg(input.files[0]);
				    }
				}
			});
		</script>
	</body>
</html>
